# Story 1.4: Input Validation and Error Handling

## Status

**Approved**

## Story

**As a** user,  
**I want** clear error messages when I provide invalid input,  
**so that** I can quickly correct my mistakes and use the tool successfully.

## Acceptance Criteria

1. Command validates that exactly 3 arguments are provided (command, amount, percentage)
2. Command displays error when too few arguments: "Error: Missing arguments. Usage: pocket-knife calc <amount> <percentage>"
3. Command displays error when too many arguments: "Error: Too many arguments. Usage: pocket-knife calc <amount> <percentage>"
4. Command validates amount is numeric (integer or decimal)
5. Command displays error for non-numeric amount: "Error: Invalid amount. Please provide a numeric value."
6. Command validates percentage is a whole number (integer only)
7. Command displays error for non-integer percentage: "Error: Invalid percentage. Please provide a whole number."
8. Command displays error for percentage with % symbol: "Error: Invalid percentage. Please provide a whole number without the % symbol."
9. Command exits with non-zero code on all error conditions
10. All error scenarios have RSpec test coverage
11. All RSpec tests pass

## Tasks / Subtasks

- [ ] **Task 1: Enhance Argument Count Validation** (AC: 1, 2, 3)
  - [ ] In CLI `parse_arguments`, check `@args.length` after 'calc' subcommand
  - [ ] If < 2 arguments after 'calc', raise `CLIError` with "Missing arguments. Usage: pocket-knife calc <amount> <percentage>"
  - [ ] If > 2 arguments after 'calc', raise `CLIError` with "Too many arguments. Usage: pocket-knife calc <amount> <percentage>"
  - [ ] Update existing parsing logic to use these specific error messages
  - [ ] Verify error messages match PRD exactly

- [ ] **Task 2: Enhance Amount Validation** (AC: 4, 5)
  - [ ] In CLI `validate_inputs`, use `Float()` to parse amount
  - [ ] Catch `ArgumentError` and raise `InvalidInputError` with "Invalid amount. Please provide a numeric value."
  - [ ] Test with string input: "abc" should trigger error
  - [ ] Test with special characters: "@#$" should trigger error
  - [ ] Verify integer amounts still work: "100" → 100.0
  - [ ] Verify decimal amounts still work: "99.99" → 99.99

- [ ] **Task 3: Enhance Percentage Validation** (AC: 6, 7, 8)
  - [ ] In CLI `validate_inputs`, use `Integer()` to parse percentage
  - [ ] Catch `ArgumentError` and raise `InvalidInputError` with "Invalid percentage. Please provide a whole number."
  - [ ] Add special check for % symbol: if `percentage_arg.include?('%')`, raise `InvalidInputError` with "Invalid percentage. Please provide a whole number without the % symbol."
  - [ ] Test with decimal: "12.5" should trigger "whole number" error
  - [ ] Test with string: "abc" should trigger "whole number" error
  - [ ] Test with % symbol: "15%" should trigger "without the % symbol" error
  - [ ] Verify integer percentages still work: "20" → 20

- [ ] **Task 4: Verify Exit Codes** (AC: 9)
  - [ ] Review `bin/pocket-knife` exception handling
  - [ ] Confirm `InvalidInputError` exits with code 2
  - [ ] Confirm `CLIError` exits with code 1
  - [ ] Confirm `CalculationError` exits with code 1
  - [ ] Confirm `StandardError` exits with code 1
  - [ ] Test manually: run invalid commands and check `echo $?` after each

- [ ] **Task 5: Write Unit Tests for Error Messages** (AC: 10, 11)
  - [ ] Update `spec/integration/cli_spec.rb` with error message tests
  - [ ] Test too few args: `run(['calc', '100'])` raises CLIError with "Missing arguments"
  - [ ] Test too many args: `run(['calc', '100', '20', '30'])` raises CLIError with "Too many arguments"
  - [ ] Test invalid amount: `run(['calc', 'abc', '20'])` raises InvalidInputError with "Invalid amount"
  - [ ] Test invalid percentage string: `run(['calc', '100', 'xyz'])` raises InvalidInputError with "whole number"
  - [ ] Test invalid percentage decimal: `run(['calc', '100', '12.5'])` raises InvalidInputError with "whole number"
  - [ ] Test percentage with % symbol: `run(['calc', '100', '15%'])` raises InvalidInputError with "without the % symbol"
  - [ ] Verify error messages match PRD exactly

- [ ] **Task 6: Write E2E Tests for Error Scenarios** (AC: 9, 10, 11)
  - [ ] Update `spec/e2e/pocket_knife_spec.rb` with exit code tests
  - [ ] Test missing args and verify exit code 1: `` `#{bin_path} calc 100 2>&1` ``
  - [ ] Test too many args and verify exit code 1: `` `#{bin_path} calc 100 20 30 2>&1` ``
  - [ ] Test invalid amount and verify exit code 2: `` `#{bin_path} calc abc 20 2>&1` ``
  - [ ] Test invalid percentage and verify exit code 2: `` `#{bin_path} calc 100 12.5 2>&1` ``
  - [ ] Test % symbol and verify exit code 2: `` `#{bin_path} calc 100 15% 2>&1` ``
  - [ ] Verify error messages appear in STDERR (2>&1 captures both)

- [ ] **Task 7: Add Edge Case Tests** (AC: 10, 11)
  - [ ] Test negative percentage: `run(['calc', '100', '-20'])` should be valid (or raise if we want to prevent negatives)
  - [ ] Test very large numbers: `run(['calc', '999999999', '15'])` should work
  - [ ] Test zero values: `run(['calc', '0', '0'])` should output "0.00"
  - [ ] Test scientific notation: `run(['calc', '1e5', '10'])` should work (Float() handles it)
  - [ ] Test special float values: Infinity, -Infinity should raise CalculationError
  - [ ] Document edge case behavior in tests

- [ ] **Task 8: Improve Error Message Formatting** (AC: 2, 3, 5, 7, 8)
  - [ ] Ensure all error messages start with "Error: "
  - [ ] Ensure usage hint included where helpful: "Usage: pocket-knife calc <amount> <percentage>"
  - [ ] Keep messages concise and actionable
  - [ ] Use consistent punctuation (periods at end of sentences)
  - [ ] Review all error messages for clarity and professionalism

- [ ] **Task 9: Validation and Regression Testing** (AC: 11)
  - [ ] Run full test suite: `bundle exec rspec`
  - [ ] Verify all previous tests still pass (from stories 1.1, 1.2, 1.3)
  - [ ] Verify new error handling tests pass
  - [ ] Run RuboCop: `bundle exec rubocop`
  - [ ] Fix any new RuboCop offenses
  - [ ] Check SimpleCov coverage (should remain >90%)

- [ ] **Task 10: Manual Error Testing** (AC: all)
  - [ ] Test: `./bin/pocket-knife calc 100` → "Error: Missing arguments..."
  - [ ] Test: `./bin/pocket-knife calc 100 20 30` → "Error: Too many arguments..."
  - [ ] Test: `./bin/pocket-knife calc abc 20` → "Error: Invalid amount..."
  - [ ] Test: `./bin/pocket-knife calc 100 xyz` → "Error: Invalid percentage...whole number"
  - [ ] Test: `./bin/pocket-knife calc 100 12.5` → "Error: Invalid percentage...whole number"
  - [ ] Test: `./bin/pocket-knife calc 100 15%` → "Error: Invalid percentage...without the % symbol"
  - [ ] Verify exit codes with `echo $?` after each command
  - [ ] Verify error output goes to STDERR (redirect: `2>&1`)

## Dev Notes

### Previous Story Insights

**From Story 1.3:**
- CLI module created with basic parsing and validation
- Entry point (bin/pocket-knife) has exception handling with exit codes
- Basic validation implemented (Integer/Float parsing)
- Integration and E2E tests established

**This Story Enhances:**
- More specific error messages matching PRD requirements
- Additional validation for edge cases (% symbol detection)
- Comprehensive test coverage for all error scenarios
- Better argument count validation messages

### Error Handling Strategy

[Source: architecture.md#9-error-handling-strategy]

**Error Classes and Exit Codes:**
- `InvalidInputError` → Exit code 2 (user input problems)
- `CLIError` → Exit code 1 (command usage problems)
- `CalculationError` → Exit code 1 (calculation failures)
- `StandardError` → Exit code 1 (unexpected errors)

**Exit Code Convention:**
- 0 = Success
- 1 = General error (CLI usage, calculation failure)
- 2 = Input validation error (invalid user input)

**Error Message Template:**
```
Error: [Clear description of what went wrong]

Example: Error: Invalid percentage. Please provide a whole number.
```

### Specific Error Messages

[Source: prd.md#story-1.4-acceptance-criteria]

**Required Error Messages (must match exactly):**

1. **Missing arguments:**
   - "Error: Missing arguments. Usage: pocket-knife calc <amount> <percentage>"
   - Triggered when: < 2 arguments after 'calc' subcommand

2. **Too many arguments:**
   - "Error: Too many arguments. Usage: pocket-knife calc <amount> <percentage>"
   - Triggered when: > 2 arguments after 'calc' subcommand

3. **Invalid amount:**
   - "Error: Invalid amount. Please provide a numeric value."
   - Triggered when: Float(amount) raises ArgumentError

4. **Invalid percentage (non-integer):**
   - "Error: Invalid percentage. Please provide a whole number."
   - Triggered when: Integer(percentage) raises ArgumentError

5. **Percentage with % symbol:**
   - "Error: Invalid percentage. Please provide a whole number without the % symbol."
   - Triggered when: percentage argument contains '%' character

### Validation Logic Flow

**Step 1: Argument Count Validation**
```ruby
def parse_arguments
  raise CLIError, "Missing subcommand" if @args.empty?
  raise CLIError, "Unknown subcommand" unless @args[0] == 'calc'
  
  args_after_calc = @args[1..-1]
  
  if args_after_calc.length < 2
    raise CLIError, "Missing arguments. Usage: pocket-knife calc <amount> <percentage>"
  elsif args_after_calc.length > 2
    raise CLIError, "Too many arguments. Usage: pocket-knife calc <amount> <percentage>"
  end
  
  @amount_arg = args_after_calc[0]
  @percentage_arg = args_after_calc[1]
end
```

**Step 2: Type and Format Validation**
```ruby
def validate_inputs
  # Check for % symbol first (before parsing)
  if @percentage_arg.include?('%')
    raise InvalidInputError, 
      "Invalid percentage. Please provide a whole number without the % symbol."
  end
  
  # Parse amount
  begin
    @base = Float(@amount_arg)
  rescue ArgumentError
    raise InvalidInputError, "Invalid amount. Please provide a numeric value."
  end
  
  # Parse percentage
  begin
    @percentage = Integer(@percentage_arg)
  rescue ArgumentError
    raise InvalidInputError, "Invalid percentage. Please provide a whole number."
  end
  
  # Additional validation
  raise CalculationError, "Percentage cannot be negative" if @percentage < 0
  raise CalculationError, "Amount must be finite" unless @base.finite?
end
```

### Testing Strategy

**Error Message Testing Pattern:**
```ruby
RSpec.describe PocketKnife::CLI do
  describe 'error handling' do
    context 'with missing arguments' do
      it 'raises CLIError with specific message' do
        expect { described_class.run(['calc', '100']) }
          .to raise_error(
            PocketKnife::CLIError, 
            /Missing arguments.*Usage:/
          )
      end
    end
    
    context 'with percentage containing % symbol' do
      it 'raises InvalidInputError with specific message' do
        expect { described_class.run(['calc', '100', '15%']) }
          .to raise_error(
            PocketKnife::InvalidInputError,
            /without the % symbol/
          )
      end
    end
  end
end
```

**Exit Code Testing Pattern:**
```ruby
RSpec.describe 'pocket-knife executable' do
  let(:bin_path) { File.expand_path('../../bin/pocket-knife', __dir__) }
  
  it 'exits with code 2 for invalid input' do
    `#{bin_path} calc 100 abc 2>/dev/null`
    expect($?.exitstatus).to eq(2)
  end
  
  it 'exits with code 1 for CLI errors' do
    `#{bin_path} calc 100 2>/dev/null`
    expect($?.exitstatus).to eq(1)
  end
end
```

### Edge Cases to Handle

**Numeric Edge Cases:**
- Scientific notation: "1e5" (Float() handles this)
- Negative numbers: "-100" (should work for amount, policy decision for percentage)
- Very large numbers: "999999999" (should work)
- Float special values: "Infinity", "-Infinity", "NaN" (should raise CalculationError)

**String Edge Cases:**
- Empty string: "" (Float/Integer will raise ArgumentError)
- Whitespace: "  100  " (Float/Integer handle trimming)
- Leading zeros: "0100" (parsed as 100)
- Hexadecimal: "0x10" (Integer() will parse as 16 - may want to prevent)

**Percentage Symbol Variations:**
- "15%" (should be detected and rejected)
- "% 15" (Integer() will raise ArgumentError anyway)
- "15 %" (Integer() will raise ArgumentError anyway)

### Coding Standards

**Error Message Guidelines:**
1. Start with "Error: " prefix
2. Describe what went wrong clearly
3. Provide actionable guidance when possible
4. Include usage hint for command structure errors
5. Use consistent punctuation
6. Keep messages under 100 characters when possible
7. Be specific (not "invalid input" but "Invalid percentage. Please provide a whole number.")

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-04 | 0.1 | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
