# Story 3.1: Product Storage Foundation

## Status

**Completed** ✅ (November 6, 2025)

## Story

**As a** user,  
**I want** to store products with their prices in a local database,  
**so that** I can maintain a persistent catalog of products for calculations.

## Acceptance Criteria

1. ✅ SQLite3 gem added as optional dependency in `:storage` group
2. ✅ Database connection manager implemented at `lib/pocket_knife/storage/database.rb`
3. ✅ Database auto-creates at `~/.pocket-knife/products.db` on first use
4. ✅ Products table created with schema: id (PK), name (unique, NOT NULL), price (>=0, NOT NULL), created_at, updated_at
5. ✅ Product model implemented at `lib/pocket_knife/storage/product.rb` with CRUD operations
6. ✅ `store-product "<name>" <price>` command implemented in CLI
7. ✅ Product name validated (cannot be empty or whitespace-only)
8. ✅ Price validated (must be numeric and non-negative)
9. ✅ Duplicate product names rejected with clear error message
10. ✅ Success message displays product details (name, formatted price, ID)
11. ✅ Missing sqlite3 gem handled gracefully with installation instructions
12. ✅ Comprehensive unit tests written (19 database + 35 product model = 54 tests)
13. ✅ Integration tests written (8 CLI integration tests)
14. ✅ All 185 tests passing (123 existing + 62 new storage tests)
15. ✅ README.md updated with storage feature documentation
16. ✅ Help text updated with store-product examples
17. ✅ Zero RuboCop offenses
18. ✅ 77% code coverage maintained

## Implementation Details

- **Storage directory:** `~/.pocket-knife/`
- **Database file:** `products.db`
- **Table:** `products` with name index for fast lookup (case-insensitive)
- **Exit codes:** 0 (success), 1 (user error/duplicate), 2 (invalid input)
- **Optional feature:** Requires `bundle install --with storage`

## Test Coverage

- **Unit tests:** 54 (database: 19, product model: 35)
- **Integration tests:** 8 (CLI command execution)
- **Total new tests:** 62
- **All existing tests:** 123 (still passing)
- **Total test suite:** 185 examples, 0 failures, 1 pending

## Tasks / Subtasks

- [x] **Task 1: Add SQLite3 Dependency** (AC: 1)
  - [x] Add sqlite3 gem to Gemfile in `:storage` group
  - [x] Document optional installation in README
  - [x] Test gem loading with graceful failure

- [x] **Task 2: Implement Database Connection Manager** (AC: 2, 3, 4)
  - [x] Create `lib/pocket_knife/storage/database.rb`
  - [x] Implement singleton connection pattern
  - [x] Create auto-initialization (directory + file creation)
  - [x] Implement schema migration (CREATE TABLE IF NOT EXISTS)
  - [x] Add products table with proper constraints
  - [x] Add index on name column (case-insensitive)
  - [x] Implement `storage_available?` check
  - [x] Implement `reset_connection!` for testing

- [x] **Task 3: Implement Product Model** (AC: 5, 7, 8, 9)
  - [x] Create `lib/pocket_knife/storage/product.rb`
  - [x] Implement `Product.create(name:, price:)` method
  - [x] Implement `Product.find_by_name(name)` (case-insensitive)
  - [x] Implement `Product.all` method (ordered by created_at)
  - [x] Implement `Product.exists?(name)` method
  - [x] Add name validation (non-empty, non-whitespace)
  - [x] Add price validation (numeric, >= 0)
  - [x] Add duplicate name check with DuplicateProductError
  - [x] Implement formatted_price method ($XXX.XX format)
  - [x] Add custom error classes (InvalidProductNameError, InvalidProductPriceError, DuplicateProductError)

- [x] **Task 4: Implement CLI Command** (AC: 6, 10, 11)
  - [x] Add `store-product` command to CLI router
  - [x] Parse command-line arguments (name, price)
  - [x] Check storage availability, show instructions if missing
  - [x] Call Product.create with validated inputs
  - [x] Display success message with product details
  - [x] Handle errors with appropriate exit codes
  - [x] Update help text with examples

- [x] **Task 5: Write Unit Tests** (AC: 12)
  - [x] Database spec: connection management (19 tests)
    - [x] Connection singleton behavior
    - [x] Directory and file creation
    - [x] Schema creation and validation
    - [x] Storage availability detection
    - [x] Connection reset
  - [x] Product spec: CRUD operations (35 tests)
    - [x] Create with valid data
    - [x] Name validation (empty, whitespace, nil)
    - [x] Price validation (negative, non-numeric, zero, positive)
    - [x] Duplicate detection
    - [x] Find by name (case-insensitive)
    - [x] List all products
    - [x] Exists check
    - [x] Formatted price output

- [x] **Task 6: Write Integration Tests** (AC: 13)
  - [x] Create `spec/integration/storage_cli_spec.rb` (8 tests)
  - [x] Test successful product storage
  - [x] Test database auto-creation
  - [x] Test duplicate product rejection
  - [x] Test price validation
  - [x] Test name validation
  - [x] Test persistence across CLI invocations
  - [x] Use tmpdir for test isolation

- [x] **Task 7: Update Documentation** (AC: 15, 16)
  - [x] Update README.md with storage feature section
  - [x] Add installation instructions for storage group
  - [x] Add store-product command examples
  - [x] Update help text in CLI module
  - [x] Document database location and schema

- [x] **Task 8: Quality Verification** (AC: 14, 17, 18)
  - [x] Run full test suite (verify 185 passing)
  - [x] Run RuboCop (verify 0 offenses)
  - [x] Check code coverage (verify 77%+)
  - [x] Manual testing of store-product command
  - [x] Verify no regressions in existing features

## Completion Summary

**Completed:** November 6, 2025

**Metrics:**
- 62 new tests added (54 unit + 8 integration)
- 185 total tests passing (0 failures, 1 pending)
- 0 RuboCop offenses (25 files inspected)
- 77.29% code coverage (exceeds 75% threshold)
- ~200 LOC implementation
- ~600 LOC tests

**Files Created:**
- `lib/pocket_knife/storage/database.rb` (~80 LOC)
- `lib/pocket_knife/storage/product.rb` (~120 LOC)
- `spec/unit/storage/database_spec.rb` (~200 LOC)
- `spec/unit/storage/product_spec.rb` (~300 LOC)
- `spec/integration/storage_cli_spec.rb` (~100 LOC)

**Files Modified:**
- `Gemfile` (added `:storage` group with sqlite3)
- `lib/pocket_knife/cli.rb` (added store-product command)
- `lib/pocket_knife/errors.rb` (added storage error classes)
- `README.md` (added storage feature documentation)
- `spec/spec_helper.rb` (updated coverage threshold)

**Quality Gates Passed:**
- ✅ All acceptance criteria met (18/18)
- ✅ Comprehensive test coverage
- ✅ Zero code quality issues
- ✅ Documentation complete
- ✅ Zero regressions
- ✅ Manual testing successful

**Next Story:** 3.2 - List and Retrieve Products
