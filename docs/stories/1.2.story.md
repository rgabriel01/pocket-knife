# Story 1.2: Core Percentage Calculation Engine

## Status

**Approved**

## Story

**As a** user,  
**I want** to calculate what percentage of an amount equals,  
**so that** I can quickly determine percentage values without leaving my terminal.

## Acceptance Criteria

1. Calculator module exists at `lib/pocket_knife/calculator.rb`
2. Calculator has a method that accepts amount and percentage as parameters
3. Calculator correctly computes (amount × percentage) ÷ 100
4. Calculator returns result formatted to exactly 2 decimal places
5. Calculator handles integer inputs correctly (e.g., 100, 20 → 20.00)
6. Calculator handles decimal amount inputs correctly (e.g., 99.99, 10 → 10.00)
7. Calculator handles zero amount correctly (0, 50 → 0.00)
8. Calculator handles zero percentage correctly (100, 0 → 0.00)
9. Unit tests cover all calculation scenarios with 100% coverage
10. All RSpec tests pass

## Tasks / Subtasks

- [ ] **Task 1: Create Data Model - CalculationRequest** (AC: 2)
  - [ ] Create file `lib/pocket_knife/calculation_request.rb`
  - [ ] Define `PocketKnife::CalculationRequest` class
  - [ ] Add `attr_reader` for `:percentage`, `:base`, `:operation`
  - [ ] Implement `initialize` method with keyword args (percentage:, base:, operation: :percent_of)
  - [ ] Implement `valid?` method that checks: percentage.is_a?(Integer), base.is_a?(Numeric), percentage >= 0, base.finite?
  - [ ] Add YARD documentation for class and methods
  - [ ] Verify class can be instantiated

- [ ] **Task 2: Create Data Model - CalculationResult** (AC: 4)
  - [ ] Create file `lib/pocket_knife/calculation_result.rb`
  - [ ] Define `PocketKnife::CalculationResult` class
  - [ ] Add `attr_reader` for `:value`, `:formatted_value`, `:request`
  - [ ] Implement `initialize` method with keyword args (value:, request:)
  - [ ] Implement private `format_value` method using `format('%.2f', val)`
  - [ ] Implement `to_s` method that returns `formatted_value`
  - [ ] Add YARD documentation for class and methods
  - [ ] Verify formatted_value always has 2 decimal places

- [ ] **Task 3: Create Error Classes** (AC: 1)
  - [ ] Create file `lib/pocket_knife/errors.rb`
  - [ ] Define `PocketKnife::PocketKnifeError < StandardError` (base error)
  - [ ] Define `PocketKnife::InvalidInputError < PocketKnifeError` (exit code 2)
  - [ ] Define `PocketKnife::CalculationError < PocketKnifeError` (exit code 1)
  - [ ] Define `PocketKnife::CLIError < PocketKnifeError` (exit code 1)
  - [ ] Define `PocketKnife::ConfigurationError < PocketKnifeError` (exit code 1)
  - [ ] Add documentation comments for each error class
  - [ ] Verify error classes can be raised and caught

- [ ] **Task 4: Create Calculator Module** (AC: 1, 2, 3)
  - [ ] Create file `lib/pocket_knife/calculator.rb`
  - [ ] Define `PocketKnife::Calculator` class
  - [ ] Implement class method `self.calculate(request)` that:
    - Validates request using `validate_request(request)`
    - Computes percentage using `compute_percentage(request.percentage, request.base)`
    - Returns `CalculationResult.new(value: value, request: request)`
  - [ ] Implement private class method `self.compute_percentage(percentage, base)` that returns `(percentage / 100.0) * base`
  - [ ] Implement private class method `self.validate_request(request)` that raises `CalculationError` if `!request.valid?`
  - [ ] Add YARD documentation for all methods
  - [ ] Verify calculator logic with manual tests

- [ ] **Task 5: Update Main Module Loader** (AC: 1)
  - [ ] Open `lib/pocket_knife.rb`
  - [ ] Add `require_relative 'pocket_knife/errors'`
  - [ ] Add `require_relative 'pocket_knife/calculation_request'`
  - [ ] Add `require_relative 'pocket_knife/calculation_result'`
  - [ ] Add `require_relative 'pocket_knife/calculator'`
  - [ ] Verify all modules can be required without errors
  - [ ] Test with `ruby -I lib -r pocket_knife -e "puts PocketKnife::VERSION"`

- [ ] **Task 6: Write Unit Tests - CalculationRequest** (AC: 9, 10)
  - [ ] Create `spec/unit/calculation_request_spec.rb`
  - [ ] Test valid request creation with integer percentage and numeric base
  - [ ] Test `valid?` returns true for valid inputs (percentage: 15, base: 200.0)
  - [ ] Test `valid?` returns false for negative percentage
  - [ ] Test `valid?` returns false for non-integer percentage
  - [ ] Test `valid?` returns false for infinite base (Float::INFINITY)
  - [ ] Test `valid?` returns false for NaN base
  - [ ] Verify 100% coverage for CalculationRequest class
  - [ ] Run `bundle exec rspec spec/unit/calculation_request_spec.rb`

- [ ] **Task 7: Write Unit Tests - CalculationResult** (AC: 4, 9, 10)
  - [ ] Create `spec/unit/calculation_result_spec.rb`
  - [ ] Test result creation with value and request
  - [ ] Test `formatted_value` formats to exactly 2 decimal places (30.0 → "30.00")
  - [ ] Test formatting handles zero (0.0 → "0.00")
  - [ ] Test formatting handles decimals (30.5 → "30.50")
  - [ ] Test formatting handles long decimals (30.123456 → "30.12")
  - [ ] Test `to_s` returns formatted_value
  - [ ] Verify 100% coverage for CalculationResult class
  - [ ] Run `bundle exec rspec spec/unit/calculation_result_spec.rb`

- [ ] **Task 8: Write Unit Tests - Calculator** (AC: 3, 5, 6, 7, 8, 9, 10)
  - [ ] Create `spec/unit/calculator_spec.rb`
  - [ ] Test `calculate` with integer inputs (percentage: 20, base: 100 → 20.0)
  - [ ] Test `calculate` with decimal base (percentage: 10, base: 99.99 → 9.999)
  - [ ] Test `calculate` with zero percentage (percentage: 0, base: 100 → 0.0)
  - [ ] Test `calculate` with zero base (percentage: 50, base: 0 → 0.0)
  - [ ] Test `calculate` with large numbers (percentage: 15, base: 1000000 → 150000.0)
  - [ ] Test `calculate` raises CalculationError for invalid request
  - [ ] Test edge case: percentage 100 of base 100 → 100.0
  - [ ] Test result is CalculationResult instance with correct value
  - [ ] Test result has formatted_value with 2 decimal places
  - [ ] Verify 100% coverage for Calculator class
  - [ ] Run `bundle exec rspec spec/unit/calculator_spec.rb`

- [ ] **Task 9: Verify All Tests Pass** (AC: 10)
  - [ ] Run full test suite: `bundle exec rspec`
  - [ ] Verify all unit tests pass (3 spec files)
  - [ ] Check SimpleCov coverage report (should be 100% for calculator logic)
  - [ ] Run RuboCop: `bundle exec rubocop lib/pocket_knife/`
  - [ ] Fix any RuboCop offenses
  - [ ] Verify no warnings or errors

- [ ] **Task 10: Manual Verification** (AC: 3, 4, 5, 6, 7, 8)
  - [ ] Open IRB and test manually:
    ```ruby
    require_relative 'lib/pocket_knife'
    req = PocketKnife::CalculationRequest.new(percentage: 15, base: 200.0)
    result = PocketKnife::Calculator.calculate(req)
    puts result.to_s  # Should output: 30.00
    ```
  - [ ] Test zero percentage: `percentage: 0, base: 100` → "0.00"
  - [ ] Test zero base: `percentage: 50, base: 0` → "0.00"
  - [ ] Test decimal base: `percentage: 10, base: 99.99` → "10.00" (rounded)
  - [ ] Verify all results formatted to 2 decimal places

## Dev Notes

### Previous Story Insights

**From Story 1.1 (Project Setup):**
- Project structure created with `lib/pocket_knife/` for modules
- RSpec configured with SimpleCov requiring 90% coverage
- RuboCop configured with security cops enabled
- Module naming: snake_case files, PascalCase classes
- All code under `PocketKnife` namespace

### Calculator Architecture

[Source: architecture.md#5.3-calculator-module]

**Responsibility:** Pure business logic for percentage calculations.

**File Location:** `lib/pocket_knife/calculator.rb`

**Public Interface:**
```ruby
module PocketKnife
  class Calculator
    # Calculate percentage of a number
    # @param request [CalculationRequest] Validated calculation request
    # @return [CalculationResult] Result with formatted value
    # @raise [CalculationError] If calculation fails
    def self.calculate(request)
      validate_request(request)
      value = compute_percentage(request.percentage, request.base)
      CalculationResult.new(value: value, request: request)
    end

    private

    # @param percentage [Integer] Whole number percentage
    # @param base [Float] Base number
    # @return [Float] Calculated result
    def self.compute_percentage(percentage, base)
      (percentage / 100.0) * base
    end

    # @param request [CalculationRequest] Request to validate
    # @raise [CalculationError] If request invalid
    def self.validate_request(request)
      raise CalculationError, 'Invalid request' unless request.valid?
    end
  end
end
```

**Key Characteristics:**
- Stateless class with class methods only
- Zero external dependencies (pure Ruby)
- Size target: ~80 LOC
- All logic testable in isolation

**Testing Focus:**
- Edge cases: zero percentage, zero base, negative numbers
- Precision: verify 2 decimal place accuracy
- Large numbers: test with big integers/floats
- Invalid requests: proper error raising

### Data Models

[Source: architecture.md#4.1-calculation-request]

**CalculationRequest (Input):**

File: `lib/pocket_knife/calculation_request.rb`

```ruby
module PocketKnife
  class CalculationRequest
    attr_reader :percentage, :base, :operation

    # @param percentage [Integer] Whole number percentage (e.g., 15 for 15%)
    # @param base [Float] The base number to calculate percentage of
    # @param operation [Symbol] Type of calculation (:percent_of)
    def initialize(percentage:, base:, operation: :percent_of)
      @percentage = percentage
      @base = base
      @operation = operation
    end

    def valid?
      percentage.is_a?(Integer) &&
        base.is_a?(Numeric) &&
        percentage >= 0 &&
        base.finite?
    end
  end
end
```

**Validation Rules:**
- Percentage must be whole number (no decimals)
- Percentage cannot be negative
- Base must be finite (not Infinity or NaN)
- Both values required for calculation

[Source: architecture.md#4.2-calculation-result]

**CalculationResult (Output):**

File: `lib/pocket_knife/calculation_result.rb`

```ruby
module PocketKnife
  class CalculationResult
    attr_reader :value, :formatted_value, :request

    # @param value [Float] Raw calculation result
    # @param request [CalculationRequest] Original request
    def initialize(value:, request:)
      @value = value
      @request = request
      @formatted_value = format_value(value)
    end

    def to_s
      formatted_value
    end

    private

    def format_value(val)
      format('%.2f', val)
    end
  end
end
```

**Formatting Rules:**
- Always 2 decimal places (e.g., 30.00, not 30 or 30.0)
- No thousands separators
- Negative values prefixed with minus sign
- Zero values display as "0.00"

### Error Handling

[Source: architecture.md#5.4-error-classes]

**Custom Exception Hierarchy:**

File: `lib/pocket_knife/errors.rb`

```ruby
module PocketKnife
  # Base error class for all Pocket Knife errors
  class PocketKnifeError < StandardError; end

  # Invalid user input (exit code 2)
  class InvalidInputError < PocketKnifeError; end

  # Calculation failure (exit code 1)
  class CalculationError < PocketKnifeError; end

  # CLI usage error (exit code 1)
  class CLIError < PocketKnifeError; end

  # Configuration error (exit code 1)
  class ConfigurationError < PocketKnifeError; end
end
```

**For This Story:**
- Use `CalculationError` for invalid calculation requests
- Raise in `Calculator.validate_request` when `request.valid?` returns false
- Error message: "Invalid request" or more specific

### Coding Standards

[Source: architecture.md#10.1-ai-agent-development-rules]

**Critical Rules for This Story:**

1. **No Metaprogramming** - Use explicit method definitions only
2. **Explicit Over Clever** - Clear multi-step code preferred over one-liners
3. **Single Responsibility** - Each class/method has one clear purpose
4. **Fail-Fast Validation** - Validate request before computing
5. **No Global State** - Pure functions, no class variables
6. **Explicit Dependencies** - Only require what's needed
7. **Informative Error Messages** - User-friendly messages

**Ruby Style Guidelines:**
- Follow RuboCop configuration from Story 1.1
- Max 20 LOC per method
- Use `format` for string formatting, not interpolation
- YARD documentation for all public methods

### Testing

[Source: architecture.md#11.2-test-organization]

**Unit Test Requirements:**

**Location:** `spec/unit/`
**Framework:** RSpec 3.12+
**Pattern:** AAA (Arrange, Act, Assert)
**Coverage:** 95%+ for business logic (SimpleCov enforced at 90%)

**Test Structure:**
```ruby
RSpec.describe PocketKnife::Calculator do
  describe '.calculate' do
    context 'with valid input' do
      it 'calculates percentage correctly' do
        request = CalculationRequest.new(percentage: 15, base: 200)
        result = described_class.calculate(request)
        expect(result.value).to eq(30.0)
      end
    end

    context 'with invalid input' do
      it 'raises CalculationError' do
        request = instance_double(CalculationRequest, valid?: false)
        expect { described_class.calculate(request) }
          .to raise_error(PocketKnife::CalculationError)
      end
    end
  end
end
```

**Test Files to Create:**
1. `spec/unit/calculation_request_spec.rb` - Test data model validation
2. `spec/unit/calculation_result_spec.rb` - Test result formatting
3. `spec/unit/calculator_spec.rb` - Test calculation logic

**Edge Cases to Cover:**
- Zero percentage (0% of any number = 0)
- Zero base (any % of 0 = 0)
- 100% (100% of X = X)
- Decimal base (10% of 99.99 = 9.999, formatted as "10.00")
- Large numbers (15% of 1,000,000 = 150,000)
- Negative percentage (should be invalid)
- Infinity/NaN (should be invalid)

**RSpec Execution:**
```bash
# Run all unit tests
bundle exec rspec spec/unit/

# Run specific test file
bundle exec rspec spec/unit/calculator_spec.rb

# Run with coverage report
COVERAGE=true bundle exec rspec
open coverage/index.html
```

### Module Integration

**Main Module Loader Updates:**

File: `lib/pocket_knife.rb`

Must require new files in dependency order:
```ruby
# frozen_string_literal: true

module PocketKnife
  VERSION = '0.1.0'
end

# Require in dependency order (errors first, then models, then logic)
require_relative 'pocket_knife/errors'
require_relative 'pocket_knife/calculation_request'
require_relative 'pocket_knife/calculation_result'
require_relative 'pocket_knife/calculator'
```

**Why This Order:**
1. Errors first (no dependencies)
2. Data models next (depend on errors for validation)
3. Calculator last (depends on models and errors)

### Calculation Formula

[Source: architecture.md#5.3-calculator-module]

**Core Calculation:**
```ruby
(percentage / 100.0) * base
```

**Important:**
- Divide by `100.0` (float) not `100` (integer) to avoid integer division
- Formula: To find X% of Y, compute (X / 100) * Y
- Example: 15% of 200 = (15 / 100.0) * 200 = 0.15 * 200 = 30.0

**Formatting:**
- Use `format('%.2f', value)` to ensure exactly 2 decimal places
- Ruby's `format` (or `sprintf`) rounds to nearest hundredth
- Examples:
  - `30.0` → `"30.00"`
  - `30.5` → `"30.50"`
  - `30.123` → `"30.12"`
  - `30.999` → `"31.00"`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-04 | 0.1 | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
