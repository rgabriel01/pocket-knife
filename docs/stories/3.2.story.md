# Story 3.2: List and Retrieve Products

## Status

**Ready for Implementation** ðŸš€

## Story

**As a** user,  
**I want** to list all stored products and retrieve individual product details,  
**so that** I can view my product catalog and look up specific prices.

## Acceptance Criteria

1. [ ] `list-products` command displays all products in a formatted table
2. [ ] Table shows columns: ID, Name, Price (formatted with $)
3. [ ] Products sorted by creation time (oldest first)
4. [ ] Empty list displays helpful message ("No products stored yet.")
5. [ ] `get-product "<name>"` command retrieves single product by name
6. [ ] Get command displays: Name, Price, ID, Created At
7. [ ] Product not found displays clear error message
8. [ ] Both commands exit code 0 on success, 1 on not found/error
9. [ ] Integration tests for both commands (8+ tests)
10. [ ] All existing 185 tests still passing
11. [ ] Zero RuboCop offenses maintained
12. [ ] README.md updated with list/get examples

## Design Specifications

**Technical design complete:** See `docs/architecture.md` Section 13 (Story 3.2 Technical Design)

### Command: list-products

**Syntax:**
```bash
pocket-knife list-products
```

**Output Format:**
```
ID  Name      Price
--  -----     ------
1   Laptop    $999.99
2   Mouse     $29.99
3   Keyboard  $79.99
```

**Empty State:**
```
No products stored yet.
```

### Command: get-product

**Syntax:**
```bash
pocket-knife get-product "Laptop"
```

**Output Format:**
```
Product: Laptop
Price: $999.99
ID: 1
Created: 2025-11-06 14:30:22
```

**Not Found:**
```
Error: Product 'NonExistent' not found
```

## Tasks / Subtasks

- [ ] **Task 1: Implement list-products Command** (AC: 1, 2, 3, 4)
  - [ ] Add `execute_list_products` method to CLI
  - [ ] Check storage availability
  - [ ] Call `Product.all` to retrieve all products
  - [ ] Handle empty list with friendly message
  - [ ] Format output as table (ID, Name, Price columns)
  - [ ] Use `formatted_price` for price display
  - [ ] Exit with code 0

- [ ] **Task 2: Implement get-product Command** (AC: 5, 6, 7, 8)
  - [ ] Add `execute_get_product` method to CLI
  - [ ] Parse product name from command-line arguments
  - [ ] Validate name argument (required, non-empty)
  - [ ] Check storage availability
  - [ ] Call `Product.find_by_name(name)` (case-insensitive)
  - [ ] Handle product not found with error message
  - [ ] Display product details (Name, Price, ID, Created)
  - [ ] Exit code 0 on success, 1 on not found

- [ ] **Task 3: Update CLI Routing** (AC: 1, 5)
  - [ ] Add `list-products` case to command router
  - [ ] Add `get-product` case to command router
  - [ ] Update help text with new commands
  - [ ] Add examples to help display

- [ ] **Task 4: Write Integration Tests** (AC: 9)
  - [ ] Create tests in `spec/integration/storage_cli_spec.rb`
  - [ ] Test 1: list-products with empty database
  - [ ] Test 2: list-products with single product
  - [ ] Test 3: list-products with multiple products (verify order)
  - [ ] Test 4: get-product with existing product (verify all fields)
  - [ ] Test 5: get-product with non-existent product (error message)
  - [ ] Test 6: get-product case-insensitive lookup
  - [ ] Test 7: get-product without name argument (usage error)
  - [ ] Test 8: list-products table formatting verification
  - [ ] Use tmpdir for database isolation

- [ ] **Task 5: Update Documentation** (AC: 12)
  - [ ] Add list-products section to README.md
  - [ ] Add get-product section to README.md
  - [ ] Include examples with expected output
  - [ ] Document case-insensitive lookup behavior
  - [ ] Update help text in CLI

- [ ] **Task 6: Quality Verification** (AC: 10, 11)
  - [ ] Run full test suite (expect ~193 examples passing)
  - [ ] Run RuboCop (verify 0 offenses)
  - [ ] Check code coverage (expect 78-80%)
  - [ ] Manual testing of both commands
  - [ ] Test with empty database
  - [ ] Test with populated database
  - [ ] Test error cases (not found, missing args)
  - [ ] Verify no regressions in existing features

## Expected Outcomes

- **Test Count:** ~193 examples (185 current + 8 new integration tests)
- **Coverage:** 78-80% (slight increase from current 77.29%)
- **RuboCop:** 0 offenses (maintain standard)
- **LOC Added:** ~60 lines (2 CLI methods + 8 tests)
- **Documentation:** README, help text updated

## Implementation Notes

**CLI Method: execute_list_products**
```ruby
def execute_list_products
  unless Database.storage_available?
    warn "Storage feature not available. Install with: bundle install --with storage"
    exit 1
  end
  
  products = Product.all
  
  if products.empty?
    puts "No products stored yet."
    return
  end
  
  # Table formatting
  puts format('%-4s %-20s %s', 'ID', 'Name', 'Price')
  puts format('%-4s %-20s %s', '--', '----', '-----')
  
  products.each do |product|
    puts format('%-4d %-20s %s', product.id, product.name, product.formatted_price)
  end
end
```

**CLI Method: execute_get_product**
```ruby
def execute_get_product
  unless Database.storage_available?
    warn "Storage feature not available. Install with: bundle install --with storage"
    exit 1
  end
  
  name = ARGV[1]
  
  if name.nil? || name.strip.empty?
    warn "Error: Product name required"
    warn "Usage: pocket-knife get-product \"<name>\""
    exit 1
  end
  
  product = Product.find_by_name(name)
  
  if product.nil?
    warn "Error: Product '#{name}' not found"
    exit 1
  end
  
  puts "Product: #{product.name}"
  puts "Price: #{product.formatted_price}"
  puts "ID: #{product.id}"
  puts "Created: #{product.created_at}"
end
```

**Test Pattern:**
```ruby
describe 'list-products command' do
  it 'shows empty message when no products' do
    output = capture_output { described_class.run(['list-products']) }
    expect(output).to include('No products stored yet')
  end
  
  it 'displays products in table format' do
    described_class.run(['store-product', 'Laptop', '999.99'])
    described_class.run(['store-product', 'Mouse', '29.99'])
    
    output = capture_output { described_class.run(['list-products']) }
    expect(output).to include('ID')
    expect(output).to include('Name')
    expect(output).to include('Price')
    expect(output).to include('Laptop')
    expect(output).to include('$999.99')
  end
end
```

## Prerequisites

- âœ… Story 3.1 complete (Product model with `all` and `find_by_name` methods)
- âœ… Database connection manager functional
- âœ… Test isolation pattern established (tmpdir)
- âœ… 185 tests passing, 0 RuboCop offenses

## Dev Agent Activation

Ready to implement! Use this prompt:

```
/bmad-dev

Ready to implement Story 3.2: List and Retrieve Products

Context:
- Story 3.1 complete: 185 tests passing, 77% coverage
- Design complete: See docs/architecture.md Section 13
- Story file: docs/stories/3.2.story.md

Tasks:
1. Implement execute_list_products in CLI
2. Implement execute_get_product in CLI  
3. Update CLI routing
4. Write 8+ integration tests
5. Update README and help text

Expected: ~193 total tests, 0 RuboCop offenses, 78%+ coverage
```

## Estimated Effort

**Time:** 2-3 hours  
**Complexity:** Low-Medium (design complete, clear patterns established)

## Definition of Done

- [ ] All 12 acceptance criteria met
- [ ] 8+ integration tests written and passing
- [ ] Total test suite ~193 examples, 0 failures
- [ ] RuboCop: 0 offenses
- [ ] Code coverage: 78%+ 
- [ ] README.md updated
- [ ] Help text updated
- [ ] Manual testing completed
- [ ] No regressions
- [ ] Story marked complete in PRD
