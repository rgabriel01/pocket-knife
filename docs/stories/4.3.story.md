# Story 4.3: Implement ask-product CLI Command - Brownfield Addition

**Epic:** Natural Language Product Query Interface (EPIC-4)  
**Story ID:** PROD-QUERY-3  
**Estimate:** 4-5 hours  
**Priority:** High (User-Facing Feature)

---

## User Story

As a **pocket-knife user**,  
I want **to query my product database using natural language via the ask-product command**,  
So that **I can find products without memorizing exact CLI syntax or product names**.

---

## Story Context

### Existing System Integration

- **Integrates with:** 
  - `CLI` class (`lib/pocket_knife/cli.rb`)
  - `LLMConfig` class (`lib/pocket_knife/llm_config.rb`)
  - `ProductQueryTool` class (`lib/pocket_knife/product_query_tool.rb` - from Story 4.1)
  - `Product` model (`lib/pocket_knife/storage/product.rb`)
- **Technology:** Ruby 3.2+, RubyLLM gem, SQLite3 database
- **Follows pattern:** Existing `ask` command (line 41-46 routing, line 168+ implementation)
- **Touch points:** 
  - `lib/pocket_knife/cli.rb` - Add new command routing and implementation
  - Help text and documentation
  - Error handling patterns

---

## Acceptance Criteria

**Total:** 14 acceptance criteria

### Functional Requirements

- [x] 1. **CLI Command Routing**
   - Add routing in `CLI#execute` for `ask-product` subcommand
   - Follows existing pattern at line 41-46 (similar to `ask` command)
   - Routes to new `execute_ask_product` private method
   - Command format: `./bin/pocket-knife ask-product "query string"`
   - Query string can contain quotes and natural language

- [x] 2. **Dependency Validation**
   - Checks if RubyLLM gem is available using `LLMConfig.llm_available?`
   - If not available, displays error:
     ```
     LLM features not available. Install with: bundle install --with llm
     For direct product commands, use: pocket-knife get-product <name>
     ```
   - Checks if storage is available using `Product` class availability
   - If not available, displays error:
     ```
     Storage features not available. Install with: bundle install --with storage
     For calculator features, use: pocket-knife calc <amount> <percentage>
     ```
   - Checks if API key is configured using `LLMConfig.configured?`
   - If not configured, displays error:
     ```
     No API key configured. Set GEMINI_API_KEY in .env file or environment variable.
     Get a free key at: https://makersuite.google.com/app/apikey
     For direct product commands, use: pocket-knife get-product <name>
     ```
   - Exits with code 1 on validation failures

- [x] 3. **Query Processing**
   - Extracts query from command-line arguments: `@args[1..]`
   - Joins multi-word arguments with spaces
   - Strips leading/trailing whitespace
   - If query is empty, displays error:
     ```
     Missing query. Usage: pocket-knife ask-product "your question about products"
     Examples:
       pocket-knife ask-product "Is there a product called banana?"
       pocket-knife ask-product "Show me products under $10"
     For direct product commands, use: pocket-knife list-products
     ```
   - Exits with code 1 on empty query

- [x] 4. **LLM Integration**
   - Configures RubyLLM using `LLMConfig.configure!`
   - Creates ProductQueryTool instance
   - Processes query through RubyLLM with ProductQueryTool
   - Displays formatted response from tool
   - Exits with code 0 on success

- [x] 5. **Supported Query Types**
   - Existence queries: "Is there a product called banana?"
   - List all: "Show me all products", "List all products"
   - Price filtering: "Products under $10", "Items priced below 5.00"
   - Price ranges: "Products between $5 and $15", "Items priced from 10 to 20"
   - Natural variations: Different phrasings of the same intent

### Error Handling Requirements

- [x] 6. **Network Errors**
   - Catches `Errno::ECONNREFUSED`, `SocketError`
   - Displays helpful message:
     ```
     Network error: Unable to connect to Gemini API.
     Please check your internet connection and try again.
     For offline product access, use: pocket-knife list-products
     (Error: [error class])
     ```
   - Exits with code 1

- [x] 7. **API Errors**
   - Catches RubyLLM API errors (authentication, rate limiting)
   - Displays helpful message:
     ```
     API error: [error message]
     Please verify your GEMINI_API_KEY is valid.
     For direct product commands, use: pocket-knife list-products
     ```
   - Exits with code 1

- [x] 8. **Unexpected Errors**
   - Catches StandardError as fallback
   - Displays user-friendly message:
     ```
     Unexpected error occurred: [error message]
     For direct product commands, use: pocket-knife list-products
     ```
   - Exits with code 1

### Integration Requirements

- [x] 9. **Existing Commands Unchanged**
   - `pocket-knife calc` - unchanged and still works
   - `pocket-knife ask` - unchanged and still works
   - `pocket-knife store-product` - unchanged and still works
   - `pocket-knife list-products` - unchanged and still works
   - `pocket-knife get-product` - unchanged and still works
   - All other commands continue to function

- [x] 10. **Help Text Updated**
    - Update `display_help` method to include `ask-product` command
    - Add description and examples:
      ```
      ask-product "<query>"    Query products with natural language
                              Examples:
                                pocket-knife ask-product "Is there a product called banana?"
                                pocket-knife ask-product "Show me products under $10"
                                pocket-knife ask-product "Products between $5 and $15"
      ```
    - Maintain consistent formatting with existing help text

- [x] 11. **README Documentation**
    - Add new section: "Natural Language Product Queries"
    - Include command format and examples
    - Document requirements (LLM + Storage)
    - Include example queries and expected outputs
    - Add troubleshooting section for common issues

### Quality Requirements

- [x] 12. **Integration Tests Created**
    - New file: `spec/integration/ask_product_cli_spec.rb`
    - Test successful query execution:
      - Existence check query
      - List all query
      - Price filter query
      - Price range query
    - Test error handling:
      - Missing LLM gem
      - Missing storage gem
      - No API key configured
      - Empty query
      - Network error (mocked)
    - Use tmpdir for database isolation
    - Mock RubyLLM responses for consistent testing
    - Minimum 10 test scenarios

- [x] 13. **E2E Tests Extended**
    - Extend `spec/e2e/pocket_knife_spec.rb`
    - Add `ask-product` command scenarios
    - Test with real database and products
    - Verify end-to-end flow (CLI → LLM → Tool → Database → Output)
    - Test help text includes new command
    - Minimum 3 E2E scenarios

- [x] 14. **No Regressions**
    - All existing tests pass (185+ tests)
    - All existing CLI tests pass
    - All existing E2E tests pass
    - Test coverage remains at 80%+
    - RuboCop passes with 0 offenses

---

## Dev Notes

### CRITICAL Pre-Implementation Verification

**⚠️ MUST VERIFY BEFORE CODING:**

1. **Existing ask Command Pattern**
   ```ruby
   # File: lib/pocket_knife/cli.rb
   # Line 41-46: Routing pattern
   if @args[0] == 'ask'
     execute_ask
     return
   end
   
   # Line 168+: Implementation pattern
   def execute_ask
     # 1. Validate dependencies
     # 2. Extract query
     # 3. Process with LLM
     # 4. Handle errors
   end
   ```
   
   **ACTION:** Review `execute_ask` method (lines 168-235) and replicate the pattern for `execute_ask_product`.

2. **LLM Configuration Pattern**
   ```ruby
   # Check availability
   unless llm_available?
     warn_with_fallback(...)
     exit 1
   end
   
   # Check configuration
   unless llm_configured?
     warn_with_fallback(...)
     exit 1
   end
   
   # Configure
   LLMConfig.configure!
   ```
   
   **ACTION:** Use existing helper methods `llm_available?` and `llm_configured?` (defined around line 320+).

3. **Query Processing Pattern**
   ```ruby
   # File: lib/pocket_knife/cli.rb, line ~189
   query = @args[1..].join(' ').strip
   
   if query.empty?
     warn_with_fallback(...)
     exit 1
   end
   ```
   
   **ACTION:** Follow exact pattern from `execute_ask` method.

4. **Error Handling Pattern**
   ```ruby
   # File: lib/pocket_knife/cli.rb, line ~198-235
   begin
     response = process_llm_query(query)
     puts response
   rescue Errno::ECONNREFUSED, SocketError => e
     warn_with_fallback(...)
     exit 1
   rescue => e
     warn_with_fallback(...)
     exit 1
   end
   ```
   
   **ACTION:** Replicate error handling structure, but call `process_product_query` instead.

### Implementation Strategy

**Phase 1: Add Routing (15 min)**
1. Add `ask-product` routing in `execute` method after line 69
2. Follow exact pattern of existing subcommand routing
3. Route to new `execute_ask_product` method

**Phase 2: Implement execute_ask_product (2 hours)**
1. Create new private method `execute_ask_product`
2. Copy structure from `execute_ask` method
3. Validate LLM availability
4. Validate storage availability (NEW check)
5. Validate API key configuration
6. Extract and validate query
7. Call `process_product_query` method (to be implemented)
8. Handle errors with appropriate messages

**Phase 3: Implement process_product_query (1 hour)**
1. Create new private method `process_product_query(query)`
2. Create ProductQueryTool instance
3. Process query through RubyLLM with tool
4. Return formatted response string
5. Handle tool-specific errors

**Phase 4: Update Help and Documentation (30 min)**
1. Update `display_help` method
2. Update README.md with new section
3. Add examples and troubleshooting

**Phase 5: Testing (2 hours)**
1. Create integration test file
2. Write test scenarios for success paths
3. Write test scenarios for error paths
4. Create E2E tests
5. Run full test suite
6. Verify no regressions

### LLM Processing Implementation

**process_product_query method:**
```ruby
def process_product_query(query)
  # Create tool instance
  tool = ProductQueryTool.new
  
  # Configure RubyLLM with tool
  llm = RubyLLM.new(
    model: 'gemini-pro',
    tools: [tool]
  )
  
  # Process query
  response = llm.chat(query)
  
  # Return formatted response
  response.content
end
```

**ACTION:** Verify exact RubyLLM API by reviewing `process_llm_query` in existing `ask` command implementation.

### Storage Availability Check

**New helper method needed:**
```ruby
def storage_available?
  require 'pocket_knife/storage/product'
  true
rescue LoadError
  false
end
```

**ACTION:** Add this helper method near existing `llm_available?` method (around line 320).

### Error Message Consistency

**Follow existing warn_with_fallback pattern:**
```ruby
warn_with_fallback(
  'Primary error message.',
  'Additional help or context.',
  'Fallback command suggestion.',
  '(Technical details if needed)'
)
```

**ACTION:** Review existing error messages to match tone and structure.

---

## Test Coverage Requirements

### Integration Test Scenarios (10 tests)

1. **Successful Queries:**
   - Query finds existing product
   - Query lists all products
   - Query filters by price
   - Query filters by price range

2. **Validation Errors:**
   - LLM gem not installed
   - Storage gem not installed
   - No API key configured
   - Empty query provided

3. **Runtime Errors:**
   - Network connection error (mocked)
   - API authentication error (mocked)

### E2E Test Scenarios (3 tests)

1. **Happy Path:**
   - Store products, then query with natural language
   - Verify correct results returned

2. **Help Text:**
   - Verify `--help` includes ask-product command

3. **Error Flow:**
   - Attempt ask-product with invalid configuration
   - Verify helpful error message

### Test Data

**Sample Products for Testing:**
```ruby
Product.create('Banana', 1.99)
Product.create('Apple', 1.50)
Product.create('Orange', 2.99)
Product.create('Grape', 4.99)
Product.create('Mango', 3.50)
```

**Sample Queries:**
```ruby
"Is there a product called banana?"
"Show me all products"
"Products under 3.00"
"Products between 2 and 4 dollars"
```

---

## Definition of Done

- [x] `ask-product` command routing added to CLI
- [x] `execute_ask_product` method implemented
- [x] `process_product_query` method implemented
- [x] Storage availability check added
- [x] All dependency validations work correctly
- [x] Query extraction and validation works
- [x] LLM integration processes queries correctly
- [x] Error handling covers all scenarios
- [x] Help text updated with ask-product examples
- [x] README.md updated with documentation
- [x] 10+ integration tests created and passing
- [x] 3+ E2E tests created and passing
- [x] All existing tests pass (no regressions)
- [x] Test coverage >80% maintained
- [x] RuboCop passes (0 offenses)
- [x] Manual testing validates all example queries work

---

## Story Dependencies

**Depends on:**
- Story 4.1 (Product Query Tool) - ✅ Must complete first
- Story 4.2 (Extend Product Model) - ✅ Must complete first
- Story 3.1 (Product Storage) - ✅ Completed
- LLM Story 1 & 2 (ask command) - ✅ Completed

**Blocks:**
- None (final story in epic)

**Cannot Work in Parallel With:**
- Must wait for Stories 4.1 and 4.2 to complete

---

## Example Usage

### Successful Query Examples

```bash
$ ./bin/pocket-knife ask-product "Is there a product called banana?"
Product found: Banana - $1.99

$ ./bin/pocket-knife ask-product "Show me all products"
Found 5 products:
1. Apple - $1.50
2. Banana - $1.99
3. Orange - $2.99
4. Mango - $3.50
5. Grape - $4.99

$ ./bin/pocket-knife ask-product "Products under 3.00"
Found 3 products under $3.00:
1. Apple - $1.50
2. Banana - $1.99
3. Orange - $2.99

$ ./bin/pocket-knife ask-product "Products between 2 and 4 dollars"
Found 2 products between $2.00 and $4.00:
1. Orange - $2.99
2. Mango - $3.50
```

### Error Examples

```bash
$ ./bin/pocket-knife ask-product ""
Missing query. Usage: pocket-knife ask-product "your question about products"
Examples:
  pocket-knife ask-product "Is there a product called banana?"
  pocket-knife ask-product "Show me products under $10"
For direct product commands, use: pocket-knife list-products

$ ./bin/pocket-knife ask-product "find something"
# (Without LLM installed)
LLM features not available. Install with: bundle install --with llm
For direct product commands, use: pocket-knife get-product <name>
```

---

## Documentation Updates

### README.md New Section

Add after "Product Storage Features" section:

```markdown
### Natural Language Product Queries (Optional)

Ask questions about your products using natural language instead of memorizing CLI commands.

**Requirements:**
- Both LLM and Storage features installed: `bundle install --with llm storage`
- GEMINI_API_KEY configured in environment

**Usage:**
```bash
# Check if a product exists
pocket-knife ask-product "Is there a product called banana?"

# List all products
pocket-knife ask-product "Show me all products"

# Filter by price
pocket-knife ask-product "What products cost less than $10?"
pocket-knife ask-product "Show me items under 5 dollars"

# Filter by price range
pocket-knife ask-product "Products between $5 and $15"
pocket-knife ask-product "Items priced from 10 to 20 dollars"
```

**Supported Query Types:**
- Product existence checks
- List all products
- Price filtering (under/below a max price)
- Price range queries (between two prices)

**Note:** This feature requires an internet connection and uses Google Gemini API. For offline product access, use direct commands like `list-products` and `get-product`.
```

---

## Notes

This is the user-facing story that brings all the pieces together. Focus on providing excellent error messages and a smooth user experience. The LLM should "just work" for users who have the dependencies installed and configured.

Test thoroughly with various query phrasings to ensure the LLM correctly interprets user intent and calls the right ProductQueryTool functions. The goal is to make product queries feel natural and intuitive, not requiring users to remember exact command syntax.
